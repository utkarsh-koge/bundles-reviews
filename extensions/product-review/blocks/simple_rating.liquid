{% comment %}
  Customer product rating display with configurable star color.
  Usage: This is designed as a BLOCK to be added within sections in the theme editor.
{% endcomment %}

{% liquid
  comment
    Get product from either block settings (product page) or direct context (collection page)
  endcomment
  assign product = block.settings.product | default: product
  assign avg_rating_initial = product.metafields.reviews.rating.value | round: 1 | default: 0
  assign review_count_initial = product.metafields.reviews.count.value | default: 0
  
  # Calculate stars with precise decimal handling
  assign full_stars = avg_rating_initial | floor
  assign remainder = avg_rating_initial | minus: full_stars
  assign next_star = full_stars | plus: 1
%}

<div class="simple-rating-block" data-product-id="{{ product.id }}">
  <div class="rating-badge">
    
    <span class="stars-container">
      {% for i in (1..5) %}
        {% if i <= full_stars %}
          <span class="full-star">★</span>
        {% elsif i == next_star and remainder > 0 %}
          <span class="partial-star" style="--fill-percentage: {{ remainder | times: 100 }}%">
            <span class="empty-star">☆</span>
            <span class="filled-part">★</span>
          </span>
        {% else %}
          <span class="empty-star">☆</span>
        {% endif %}
      {% endfor %}
    </span>
    <span class="average-rating">
      {% if review_count_initial > 0 %}
        {{ avg_rating_initial }}
      {% else %}
        No reviews yet
      {% endif %}
    </span>
    <span class="review-count">
      {% if review_count_initial > 0 %}
        ({{ review_count_initial }})
      {% endif %}
    </span>
  </div>
</div>

<style>
  .simple-rating-block {
    display: inline-block;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    margin: 4px 0;
  }
  
  .rating-badge {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.9rem;
    line-height: 1;
  }
  
  .stars-container {
    font-size: 1rem;
    letter-spacing: 1px;
    display: inline-flex;
    color: #FFD700; 
  }
  
  .full-star {
    color: inherit;
  }
  
  .empty-star {
    color: #ccc; 
  }
  
  .partial-star {
    position: relative;
    display: inline-block;
    width: 1em;
    height: 1em;
  }
  
  .partial-star .filled-part {
    position: absolute;
    left: 0;
    width: var(--fill-percentage);
    overflow: hidden;
    color: inherit; 
  }
  
  .partial-star .empty-star {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    color: #ccc; 
  }
  
  .average-rating {
    font-weight: 600;
    color: #555;
  }
  
  .review-count {
    color: #777;
    font-size: 0.85rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const block = document.querySelector('.simple-rating-block[data-product-id="{{ product.id }}"]');
    if (!block) return;

    const productId = block.dataset.productId;
    const starsContainer = block.querySelector('.stars-container');
    const averageRatingSpan = block.querySelector('.average-rating');
    const reviewCountSpan = block.querySelector('.review-count');

    function renderStars(rating) {
      let starsHtml = '';
      const fullStars = Math.floor(rating);
      const remainder = rating - fullStars;

      for (let i = 1; i <= 5; i++) {
        if (i <= fullStars) {
          starsHtml += '<span class="full-star">★</span>';
        } else if (i === fullStars + 1 && remainder > 0) {
          starsHtml += `<span class="partial-star" style="--fill-percentage: ${remainder * 100}%">
            <span class="empty-star">☆</span>
            <span class="filled-part">★</span>
          </span>`;
        } else {
          starsHtml += '<span class="empty-star">☆</span>';
        }
      }
      return starsHtml;
    }

    // 1. Fetch Star Color
    fetch('/apps/productreview/api/settings')
      .then(response => response.json())
      .then(data => {
        if (data && data.starColor && starsContainer) {
          starsContainer.style.color = data.starColor;
        }
      })
      .catch(err => console.error('Error fetching star color:', err));

    // 2. Fetch Live Review Data
    fetch(`/apps/productreview/api/productreview?productId=${productId}`)
      .then(response => response.json())
      .then(reviews => {
        const allReviews = Array.isArray(reviews) ? reviews : [];
        if (allReviews.length > 0) {
          const totalRating = allReviews.reduce((sum, r) => sum + parseFloat(r.rating), 0);
          const avgRating = totalRating / allReviews.length;
          
          if (starsContainer) starsContainer.innerHTML = renderStars(avgRating);
          if (averageRatingSpan) averageRatingSpan.textContent = avgRating.toFixed(1);
          if (reviewCountSpan) reviewCountSpan.textContent = `(${allReviews.length})`;
        } else {
          if (starsContainer) starsContainer.innerHTML = renderStars(0);
          if (averageRatingSpan) averageRatingSpan.textContent = 'No reviews yet';
          if (reviewCountSpan) reviewCountSpan.textContent = '';
        }
      })
      .catch(err => console.error('Error fetching live reviews:', err));
  });
</script>

{% schema %}
{
  "name": "Simple Rating Display",
  "target": "section",
  "templates": ["collection", "product"],
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "autofill": true,
      "info": "This setting is for previewing the block. On product pages, it will automatically use the current product."
    }
  ]
}
{% endschema %}